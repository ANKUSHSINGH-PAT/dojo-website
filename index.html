<!DOCTYPE HTML>
<html>
	<head>
		<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no">
<link rel="stylesheet" href="/css/index.css">
		<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-3242977-13', 'auto');
  ga('send', 'pageview');

</script>
		<link rel="icon" href="/images/favicons/favicon.ico">
<link rel="apple-touch-icon-precomposed" href="/images/favicons/apple-touch-icon-precomposed.png">
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon-precomposed" sizes="120x120" href="/images/favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="/images/favicons/apple-touch-icon-152x152.png">
		<link rel="stylesheet" href="/css/tutorials.css">
		<title>Dojo Toolkit Tutorial: start/start</title>
	</head>
	<body>
		<div class="nav">
	<div class="row">
		<div class="large-12 columns">
			
				<a href="/" class="navLogo"><span>Dojo</span></a>
			
			<div class="mobileMenuToggle" data-menu-toggle></div>
			<div class="menu">
				<div class="mobileHeader">Menu</div>
				<!-- <span class="mobileLogo"></span> -->
				<ul class="inline-list">
					<li><a href="">Get Dojo</a></li>
					<li><a href="">Docs</a></li>
					<li><a href="">Help &amp; Support</a></li>
					<li><a href="">Blog</a></li>
					<li><a href="">Get Involved</a></li>
				</ul>
			</div>
		</div>
	</div>
</div>
		<main>
			<div class="row">
				<div class="large-9 columns content tutorial">
					<h2 id="creating-a-custom-store">Creating a Custom Store</h2>
<p>dstore provides a flexible selection of stores out of the box, but sometimes, it is necessary to create a custom store to better suit the needs of an application. This is a tutorial for doing just that. For our example, we create a store around the GitHub API v3 for Gists.</p>
<h3 id="foundation">Foundation</h3>
<p>At mininum, a custom store implementation should inherit from <code>dstore/Store</code> which provides core dstore behavior. We begin with the <code>Store</code> class, the base URL for the GitHub API, and an <code>Accept</code> header that requests v3 of the GitHub API.</p>
<pre><code class="lang-js">define([
    <span class="hljs-string">'dojo/_base/declare'</span>,
    <span class="hljs-string">'dstore/Store'</span>,
], <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(declare, Store)</span> </span>{
    <span class="hljs-keyword">return</span> declare(Store, {

        apiUrl: <span class="hljs-string">'https://api.github.com/'</span>,

        headers: {
            Accept: <span class="hljs-string">'application/vnd.github.v3+json'</span>
        }
    });
});
</code></pre>
<p>Every request to the GitHub API will be an HTTP request that incorporates the <code>apiUrl</code> and the store <code>headers</code>, so we pull in <code>dojo/request</code> and other dependencies and define a <code>_request</code> method to encapsulate this:</p>
<pre><code class="lang-js">define([
    <span class="hljs-string">'dojo/_base/lang'</span>,
    <span class="hljs-string">'dojo/_base/declare'</span>,
    <span class="hljs-string">'dojo/request'</span>,
    <span class="hljs-string">'dstore/Store'</span>,
], <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(lang, declare, request, Store)</span> </span>{
    <span class="hljs-keyword">return</span> declare(Store, {
        <span class="hljs-comment">// ...</span>
        _request: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(target, options)</span> </span>{
            <span class="hljs-comment">// Most responses will be in JSON, so we make that the default expected format.</span>
            options = lang.mixin({ handleAs: <span class="hljs-string">'json'</span> }, options);

            options.headers = lang.mixin({}, <span class="hljs-keyword">this</span>.headers, options.headers);

            <span class="hljs-keyword">return</span> request(<span class="hljs-keyword">this</span>.apiUrl + target, options);
        }
    });
});
</code></pre>
<p>In dstore, a store is responsible for providing operations for individual objects and the ability to retrieve collections of items. Let&#39;s start with individual objects.</p>
<h3 id="working-with-individual-objects">Working with individual objects</h3>
<p>Much like dojo object stores, dstore provides create, read, update, and delete (CRUD) operations for individual objects:</p>
<ol>
<li>Create - <code>Store#add</code></li>
<li>Read - <code>Store#get</code></li>
<li>Update - <code>Store#put</code></li>
<li>Delete - <code>Store#remove</code></li>
</ol>
<p>The GitHub API requires an OAuth token for creating, updating, and deleting gists, so we update the store to accommodate this:</p>
<pre><code class="lang-js"><span class="hljs-comment">// oAuthToken: String</span>
<span class="hljs-comment">//    An OAuth token for the current user. Required for `put` and `remove` operations.</span>
oAuthToken: <span class="hljs-literal">null</span>,

_request: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(target, options)</span> </span>{
    options = lang.mixin({ handleAs: <span class="hljs-string">'json'</span> }, options);

    options.headers = lang.mixin(
        <span class="hljs-keyword">this</span>.headers,
        <span class="hljs-keyword">this</span>.oAuthToken &amp;&amp; { Authorization: <span class="hljs-string">'token '</span> + <span class="hljs-keyword">this</span>.oAuthToken },
        options.headers
    );

    <span class="hljs-keyword">return</span> request(<span class="hljs-keyword">this</span>.apiUrl + target, options);
},
</code></pre>
<p>Each operation requires only a simple HTTP request so we define them together here:</p>
<pre><code class="lang-js">get: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(id)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._request(<span class="hljs-string">'/gists/'</span> + <span class="hljs-built_in">encodeURIComponent</span>(id), {
        method: <span class="hljs-string">'GET'</span>
    });
},

add: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(object)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._request(<span class="hljs-string">'/gists'</span>, {
        method: <span class="hljs-string">'POST'</span>,
        data: object
    });
},

put: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(object)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._request(<span class="hljs-string">'/gists/'</span> + <span class="hljs-built_in">encodeURIComponent</span>(object.id), {
        method: <span class="hljs-string">'PATCH'</span>,
        data: object
    });
},

remove: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(id)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._request(<span class="hljs-string">'/gists/'</span> + <span class="hljs-built_in">encodeURIComponent</span>(id), {
    <span class="hljs-comment">// unlike get, add, and put, GitHub's response for gist deletion is text rather than JSON</span>
        handleAs: <span class="hljs-string">'text'</span>,
        method: <span class="hljs-string">'DELETE'</span>
    });
},
</code></pre>
<p><a class="button" href="demo/customStore/custom_store_get.html">View Demo</a></p>
<h3 id="working-with-collections">Working with collections</h3>
<p>The second responsibility of a store is to provide operations for querying and retrieving collections of objects. In this section, we implement the <code>fetch</code> and <code>fetchRange</code> methods for the Gist API, and we will provide filtering and sorting support. We cannot retrieve the data for a collection without the <code>fetch</code> method. Let&#39;s start there.</p>
<h4 id="fetching">Fetching</h4>
<p>The <code>fetch</code> method retrieves a collection&#39;s items, returning a promise to an array, that is argumented with QueryResults to ensure that it can easily be iterated on:</p>
<pre><code class="lang-js">define([
    <span class="hljs-string">'dstore/QueryResults'</span>,
    <span class="hljs-comment">//...</span>
], <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(..., QueryResults, ...)</span> </span>{
    <span class="hljs-keyword">return</span> declare(Store, {
        <span class="hljs-comment">//...</span>
        fetch: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> QueryResults(<span class="hljs-keyword">this</span>._request(<span class="hljs-string">'/gists/public'</span>));
        }
</code></pre>
<p>The promise will also have a <code>totalLength</code> property, which is a promise representing the total number of objects in the collection.</p>
<p>GistStore can now retrieve a collection of public gists from GitHub&#39;s API.</p>
<p><a class="button" href="demo/customStore/custom_store_fetch.html">View Demo</a></p>
<h4 id="sorting">Sorting</h4>
<p>At the time of this writing, there is no documented API support for sorting gists, so we must sort in-memory if at all. This small disappointment turns out to be a good opportunity to demonstrate how to use the query log in conjunction with a querier factory. A querier is a function that allows query methods to compute queries locally so operations such as <code>sort</code> and <code>filter</code> can be performed on in-memory collection data. A querier factory is a method that creates a querier from query arguments and is named according to the convention <code>&#39;_create&lt;Type&gt;Querier&#39;</code>. Dstore provides default querier factories in the form of the <code>dstore/SimpleQuery</code> mixin, and <code>SimpleQuery#_createSortQuerier</code> is just what we need.</p>
<p>We define our <code>_createSortQuerier</code> method and then expand <code>fetch</code> to execute any queriers that have been applied to the collection.</p>
<pre><code class="lang-js">define([
    <span class="hljs-string">'dstore/QueryResults'</span>,
    <span class="hljs-string">'dstore/SimpleQuery'</span>,
    <span class="hljs-comment">//...</span>
], <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(QueryResults, SimpleQuery, ...)</span> </span>{
    <span class="hljs-keyword">return</span> declare(Store, {
        _createSortQuerier: SimpleQuery.prototype._createSortQuerier,
        <span class="hljs-comment">//...</span>
        fetch: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">var</span> queryLog = <span class="hljs-keyword">this</span>.queryLog;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> QueryResults(<span class="hljs-keyword">this</span>._request(<span class="hljs-string">'/gists/public'</span>).then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span></span>{
                <span class="hljs-comment">// iterate through the query log, applying each querier</span>
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = queryLog.length; i &lt; l; i++) {
                    data = queryLog[i].querier(data);
                }
                <span class="hljs-keyword">return</span> data;
            }));
        }
    });
});
</code></pre>
<p><a class="button" href="demo/customStore/custom_store_sort.html">View Demo</a></p>
<h4 id="paging">Paging</h4>
<p>The paging API for gists does not provide the total gist count which is required for dstore paging to truly function properly. For the purposes of this tutorial, we perform paging in-memory. The <code>Store#fetchRange</code> method is the dstore method used to retrieve paged data, or ranges of data. To implement this method, we will make use of our <code>fetch</code> method, and then retrieve the correct subset of the data by using the <code>slice()</code> method. When implementing <code>fetchRange</code>, we should also provide the <code>totalLength</code> property to communicate the total length of the collection. For both, we will operate on the resolution of the promised data:</p>
<pre><code class="lang-js">fetchRange: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(kwArgs)</span> </span>{
    <span class="hljs-keyword">var</span> start = kwArgs.start,
        end = kwArgs.end,
        data = <span class="hljs-keyword">this</span>.fetch();

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> QueryResults(data.then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> </span>{
        <span class="hljs-keyword">return</span> data.slice(start, end);
    }), {
        totalLength: data.then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> </span>{
            <span class="hljs-keyword">return</span> data.length;
        })
    });
}
</code></pre>
<p><a class="button" href="demo/customStore/custom_store_range.html">View Demo</a></p>
<h4 id="filtering">Filtering</h4>
<p>GitHub&#39;s Gist API provides a way to filter gists by user and since a given date. The previous code would properly filter on the client side, but since GitHub provides this API, we can more efficiently perform (at least some) filtering on the server side. Here, we add support for filtering on those axes. When <code>filter</code> is called, the filter is added to the <code>queryLog</code>. We iterate through the <code>queryLog</code> and then recurse through the filter to determine if any equivalence filters for <code>owner</code> or <code>since</code> are present, so we can take advantage of sending those filter parameters to the GitHub Gist API in <code>fetch</code>:</p>
<pre><code class="lang-js">fetch: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> queryLog = <span class="hljs-keyword">this</span>.queryLog || [];
    <span class="hljs-keyword">var</span> owner;
    <span class="hljs-keyword">var</span> since;
    <span class="hljs-keyword">var</span> serverFilter;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; queryLog.length; i++) {
        <span class="hljs-keyword">if</span> (queryLog[i].type === <span class="hljs-string">'filter'</span>) {
            checkFilter(queryLog[i].normalizedArguments[<span class="hljs-number">0</span>]);
            <span class="hljs-keyword">if</span> (serverFilter) {
                queryLog[i].serverFilter = <span class="hljs-literal">true</span>;
            }
        }
    }
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkFilter</span><span class="hljs-params">(filter)</span> </span>{
        <span class="hljs-comment">// check the filter to see if the user or since is specified</span>
        <span class="hljs-keyword">if</span> (filter.type === <span class="hljs-string">'eq'</span> || filter.type === <span class="hljs-string">'gte'</span>) {
            <span class="hljs-comment">// it is a filter for equivalence (or greater than or equal, which should used be for since)</span>
            <span class="hljs-keyword">var</span> name = filter.args[<span class="hljs-number">0</span>];
            <span class="hljs-keyword">var</span> value = filter.args[<span class="hljs-number">1</span>];
            <span class="hljs-keyword">if</span> (name === <span class="hljs-string">'owner'</span>) {
                owner = value;
                serverFilter = <span class="hljs-literal">true</span>;
            }
            <span class="hljs-keyword">if</span> (name === <span class="hljs-string">'since'</span>) {
                since = value;
                serverFilter = <span class="hljs-literal">true</span>;
            }
        }
        <span class="hljs-keyword">if</span> (filter.type === <span class="hljs-string">'and'</span>) {
            <span class="hljs-comment">// need to check each part</span>
            checkFilter(filter.args[<span class="hljs-number">0</span>], filter.args[<span class="hljs-number">1</span>]);
        }
    }
    <span class="hljs-keyword">var</span> target = owner ? <span class="hljs-string">'/users/'</span> + <span class="hljs-built_in">encodeURIComponent</span>(owner) + <span class="hljs-string">'/gists'</span> : <span class="hljs-string">'/gists/public'</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> QueryResults(<span class="hljs-keyword">this</span>._request(<span class="hljs-string">'/gists/public'</span>, {
         query: since ? { since: since.toISOString() } : <span class="hljs-literal">null</span>
    }).then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span></span>{
        <span class="hljs-comment">// iterate through the query log, applying each querier</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = queryLog.length; i &lt; l; i++) {
            <span class="hljs-keyword">var</span> logEntry = queryLog[i];
            <span class="hljs-comment">// ignore server filters, as they have already been applied</span>
            <span class="hljs-keyword">if</span> (!logEntry.serverFilter) {
                data = logEntry.querier(data);
            }
        }
        <span class="hljs-keyword">return</span> data;
    }));
}
</code></pre>
<p><a class="button" href="demo/customStore/custom_store_filter.html">View Demo</a></p>
<h3 id="conclusion">Conclusion</h3>
<p>We now have a basic, custom store that wraps the GitHub Gist API. It can perform CRUD operations on individual gists and sort, filter, and page collections of gists.</p>

				</div>
			</div>
		</main>
		<div class="footer">

</div>
	</body>
</html>